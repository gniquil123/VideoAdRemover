# 视频广告移除工具

一个基于C#和OpenCvSharp开发的视频广告自动检测与移除工具，支持手动和自动两种广告检测方式。

## 功能特性

### 🎯 核心功能
- **广告自动检测**：基于图像处理算法自动检测视频中的广告片段
- **广告手动编辑**：支持手动添加、修改、删除广告时间段
- **广告移除**：将检测到的广告片段从视频中移除，生成无广告视频
- **多时间段检测**：支持设置多个检测时间段，提高检测效率
- **图片相似度比较**：支持比较两张图片的相似度，用于验证检测算法

### 🎨 界面特性
- **黑暗主题支持**：支持明亮/黑暗主题切换
- **实时进度显示**：检测和移除过程中显示实时进度
- **直观的时间段管理**：可视化管理检测和广告时间段
- **清晰的检测结果展示**：表格形式展示检测到的广告片段

### ⚙️ 技术特性
- **异步处理**：检测和移除过程采用异步处理，不阻塞UI
- **断点续跑**：支持从任意步骤开始执行
- **配置持久化**：自动保存和加载用户配置
- **详细日志**：记录操作过程和错误信息

## 技术栈

| 技术/库 | 版本 | 用途 |
|---------|------|------|
| C# | 10.0 | 开发语言 |
| .NET 6 | 6.0 | 运行时框架 |
| OpenCvSharp4 | 4.8.0 | 图像处理和视频分析 |
| Windows Forms | - | GUI界面 |
| FFmpeg | - | 视频处理（通过命令行调用） |

## 安装说明

### 系统要求
- Windows 10/11 64位系统
- .NET 6.0 运行时
- FFmpeg（需添加到系统环境变量）

### 安装步骤
1. 从发布页面下载最新版本的安装包
2. 运行安装程序，按照提示完成安装
3. 确保FFmpeg已正确安装并添加到系统环境变量
4. 启动应用程序

## 使用指南

### 1. 选择视频文件
- 点击"浏览"按钮选择要处理的视频文件
- 支持的视频格式：MP4、AVI、MOV、MKV等

### 2. 设置广告检测参数
- **广告时间设置**：设置广告的大致时间段范围
- **扫描间隔**：设置视频帧扫描的时间间隔（秒），间隔越小检测越精确但速度越慢

### 3. 设置检测时间段（可选）
- 如果只需要检测视频的特定部分，可以添加多个检测时间段
- 点击"添加时间段"按钮添加新的检测时间段
- 可以删除或清空检测时间段

### 4. 执行广告检测
- 点击"检测广告"按钮开始自动检测广告
- 检测过程中可以点击"停止检测"按钮终止检测
- 检测结果会实时显示在"检测结果"列表中

### 5. 编辑检测结果
- 在检测结果列表中选择一个广告片段
- 修改开始时间、结束时间和备注
- 点击"更新"按钮保存修改，或点击"删除"按钮删除该片段
- 点击"添加"按钮可以手动添加广告片段

### 6. 移除广告
- 确保检测结果列表中包含所有需要移除的广告片段
- 点击"移除广告"按钮开始移除广告
- 移除完成后，会在原视频目录生成一个"_无广告"后缀的新视频文件

### 7. 测试合并（可选）
- 点击"测试合并"按钮可以测试视频片段合并功能
- 用于验证广告移除后的视频质量

## 项目结构

```
VideoAdRemover/
├── AdDetector.cs          # 广告检测核心算法
├── AdSegment.cs           # 广告片段数据模型
├── ConfigManager.cs       # 配置管理
├── Form1.cs               # 主窗体逻辑
├── Form1.Designer.cs      # 主窗体设计
├── Form1.resx             # 主窗体资源
├── Logger.cs              # 日志管理
├── MergeTestConsole.cs    # 合并测试控制台
├── MergeTestForm.cs       # 合并测试窗体
├── MergeTestForm.Designer.cs # 合并测试窗体设计
├── Program.cs             # 程序入口
├── TestAdDetector.cs      # 广告检测器测试
├── VideoAdRemover.csproj  # 项目文件
├── VideoAnalyzer.cs       # 视频分析器
├── VideoEditor.cs         # 视频编辑器
└── VideoInfo.cs           # 视频信息模型
```

## 开发说明

### 环境搭建
1. 安装Visual Studio 2022或更高版本
2. 安装.NET 6.0 SDK
3. 克隆项目仓库
4. 打开`VideoAdRemover.sln`解决方案
5. 还原NuGet包
6. 编译并运行项目

### 核心算法说明

#### 广告检测算法
1. **帧提取**：按照设定的扫描间隔从视频中提取帧
2. **帧特征提取**：使用OpenCvSharp提取帧的特征
3. **相似度比较**：比较相邻帧的相似度
4. **广告边界检测**：根据相似度变化检测广告的开始和结束位置
5. **广告片段合并**：将连续的广告帧合并为广告片段

#### 视频编辑算法
1. **视频分段**：根据广告片段将视频分割为多个片段
2. **片段合并**：使用FFmpeg将非广告片段合并为完整视频
3. **进度跟踪**：实时跟踪视频处理进度

### 主题定制
项目支持明亮和黑暗两种主题，可以通过修改`ApplyTheme`方法来自定义主题颜色：

```csharp
// 主题颜色定义
Color backgroundColor = isDarkTheme ? Color.FromArgb(30, 30, 30) : Color.White;
Color foregroundColor = isDarkTheme ? Color.White : Color.Black;
Color buttonColor = isDarkTheme ? Color.FromArgb(60, 60, 60) : Color.White;
```

## 配置说明

### 配置文件
配置文件位于应用程序运行目录下的`config.xml`，包含以下配置项：

| 配置项 | 描述 | 默认值 |
|--------|------|--------|
| LastMoviePath | 上次使用的视频文件路径 | 空字符串 |
| AdStartHour | 广告开始时间（小时） | 0 |
| AdStartMinute | 广告开始时间（分钟） | 0 |
| AdStartSecond | 广告开始时间（秒） | 0 |
| AdEndHour | 广告结束时间（小时） | 0 |
| AdEndMinute | 广告结束时间（分钟） | 30 |
| AdEndSecond | 广告结束时间（秒） | 0 |
| DarkTheme | 是否使用黑暗主题 | true |
| ScanIntervalSec | 扫描间隔（秒） | 1.0 |

### 日志文件
日志文件位于`Logs`目录下，按日期命名，记录应用程序的运行情况和错误信息。
